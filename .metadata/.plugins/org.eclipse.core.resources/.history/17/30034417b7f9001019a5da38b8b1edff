package com.project.bookstack.repositories;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;
import org.springframework.stereotype.Repository;

import com.project.bookstack.dto.BookCardDTO;
import com.project.bookstack.dto.member.BookDTO;
import com.project.bookstack.entities.Book;

@Repository
public interface MemberRepository extends JpaRepository<Book, Integer> {
	
	/**
	 * SQL equivalent:
	 *
	 * SELECT 
	 *   b.book_id,
	 *   b.title,
	 *   b.author,
	 *   COALESCE(AVG(r.rating), 0) AS avg_rating,
	 *   COUNT(DISTINCT l.user_id) AS like_count,
	 *   MAX(CASE WHEN l.user_id = :userId THEN 1 ELSE 0 END) AS liked_by_user
	 * FROM book_table b
	 * LEFT JOIN book_rating r ON r.book_id = b.book_id
	 * LEFT JOIN book_likes l ON l.book_id = b.book_id
	 * GROUP BY b.book_id, b.title, b.author;
	 */
	@Query("""
	    SELECT new com.project.bookstack.dto.BookCardDTO(
	        b.bookId,
	        b.title,
	        b.author,
	        COALESCE(AVG(r.rating), 0),
	        COUNT(DISTINCT l.user.userId),
	        MAX(CASE WHEN l.user.userId = :userId THEN true ELSE false END)
	    )
	    FROM Book b
	    LEFT JOIN b.ratings r
	    LEFT JOIN b.likedByUsers l
	    GROUP BY b.bookId, b.title, b.author
	""")
	List<BookCardDTO> getAllBooks(@Param("userId") Integer userId);

	List<BookCardDTO> getAllBooks(Integer userId);

	
//	@Query("""
//		    SELECT b.bookId,b.isbn,b.title,b.author,b.description,
//			    b.publisher,b.edition,b.action,b.actionDate,b.numberOfCopies,
//			    b.numberOfCopiesRemaining,b.bookImage
//			    FROM Book b
//	""")
//	List<BookCardDTO> getAllBooks();
}
