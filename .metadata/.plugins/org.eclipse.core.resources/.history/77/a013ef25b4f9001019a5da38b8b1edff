package com.project.bookstack.repositories;

import java.util.List;

import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.stereotype.Repository;

import com.project.bookstack.dto.BookCardDTO;
import com.project.bookstack.dto.member.BookDTO;
import com.project.bookstack.entities.Book;

@Repository
public interface MemberRepository extends JpaRepository<Book, Integer> {
	
	@Query(value = """
		    SELECT 
	        b.book_id AS bookId,
	        b.title,
	        b.author,
	        COALESCE(AVG(r.rating), 0) AS averageRating,
	        COUNT(DISTINCT l.user_id) AS likeCount,
	        MAX(CASE WHEN l.user_id = :userId THEN true ELSE false END) AS likedByCurrentUser
	    FROM book_table b
	    LEFT JOIN book_rating r ON r.book_id = b.book_id
	    LEFT JOIN book_likes l ON l.book_id = b.book_id
	    GROUP BY b.book_id, b.title, b.author
	""", nativeQuery = true)
	List<BookCardDTO> getAllBooks();

	
//	@Query("""
//		    SELECT b.bookId,b.isbn,b.title,b.author,b.description,
//			    b.publisher,b.edition,b.action,b.actionDate,b.numberOfCopies,
//			    b.numberOfCopiesRemaining,b.bookImage
//			    FROM Book b
//	""")
//	List<BookCardDTO> getAllBooks();
}
